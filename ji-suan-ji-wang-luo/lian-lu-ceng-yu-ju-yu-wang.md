# 链路层与局域网

两种链路层信道：

- 广播信道：连接有线局域网、卫星网和混合光纤同轴电缆(HFC)接入网中的多台主机，因为许多主机与相同广播信道连接，所以需要媒体访问协议来协调帧传输

- 点对点通信链路：长距离链路连接的两台路由器、办公室计算机与他们连接到邻近的以太网交换机之间。点到点协议(Point-to-Point Protocol,PPP)

## 6.1概述

为方便讨论，本章将所有运行链路层协议的任何设备均称为**节点(node)**(包括主机、路由器、交换机和WIFI接入点)

将沿着通信路径连接相邻节点的通信信道称为**链路(link)**

### 6.1.1链路层提供的服务

**可能**包括：

- 成帧：帧由一个数据字段和若干首部字段组成
- 链路接入：**媒体访问控制(Medium Access Control, MAC)**协议规定了帧在链路上的接入规则，对于点对点；链路，MAC协议比较简单(或者不存在)，当多个节点共享单个广播链路时，即多路访问问题，在这里MAC协议用于协调多个节点的帧传输。
- 可靠交付：保证无差错的经链路层移动每个网络层数据报，目的在于纠正一个差错而不是通过运输层或应用层协议来迫使重传。但是对于一些低比特差错的链路，如光纤、同轴电缆和很多双绞铜线链路，链路层的可靠交付有时被视为不必要的，所以很多有限的链路层协议不提供可靠交付服务
- 差错检测和纠正：由于信号衰减和电磁噪声导致差错。许多链路层协议会让发送节点在帧中包括差错检测比特，让接收节点进行差错检查。

### 6.1.2链路层实现位置

链路层主体部分是在**网络适配器(network adapter)**中实现的，也被称为**网络接口卡(Network Interface Card,NIC)**, 网络适配器的核心是链路层控制器，控制器通常是一个实现了许多链路层服务的专用芯片。

之前很多网络适配器是物理上分离的卡，但现在越来越多的网络适配器被综合进入主机的主板，即所谓的局域网在主板配置

尽管大部分链路层是在硬件中实现的，但部分链路层是在运行于主机CPU上的软件中实现的。链路层中的软件组件实现了高层链路层功能，如组装链路层寻址信息和激活控制器硬件。接收端的链路层软件响应控制器中断、处理差错条件和将数据报向上传递给网络层。

链路层是协议栈上硬件与软件交接的地方

## 6.2 差错检测和纠正技术

我们使用**差错检测和纠正比特(Error-Detection and-Correction, EDC)**来增强数据D.(D包括了链路层首部信息和数据报)。我们发送D和EDC，根据接收到的D'和EDC'来判断D'是否与D一致

我们现在研究在传输数据中检测差错的三种方法：

- 奇偶校验（描述差错检测和纠正背后隐藏的基本思想）

- 检验和方法（通常更多的运用于运输层）

- 循环冗余检测（更多的应用在适配器中的链路层）

### 6.2.1奇偶校验

单个奇偶校验位(假设数据有d个比特)：

- 偶校验：附加一个比特使得d+1个比特中1的数量总是偶数

- 奇校验：附加一个比特使得d+1个比特中1的数量总是奇数

但是测量已经表明了差错经常以突发形势聚集在一起，而不是独立发生。

考虑更一般的**二维奇偶校验(two-dimensional parity)**:将d个比特划分为$i$ 行$j$ 列，然后对每行每列都计算奇偶值，产生的$i+j+1$ 个奇偶比特构成了链路层帧的差错检测比特。这种方式可以检测和纠正单个比特的差错，可以检测(但不能纠正)两个比特差错的组合。

接收方检测和纠正差错的能力叫做**前向纠错(Forward Error Correction, FEC)**

### 6.2.2 检验和方法

将d比特数据看成一个k比特整数处理，一个简单的检验和方法就是将这k比特数加起来，将和作为差错检测比特

**因特网检验和**方法基于这种方法，将数据的字节作为16比特的整数等待并求和，这个和的反码形成了携带在报文段首部的因特网检验和。接收方对接收到的数据（包括检验和）的和取反码，并检测结果是否为全1，如果有一个比特为0，就可以检验出差错(在书的3.3节讨论)

为什么运输层使用检验和而链路层采用CRC呢：因为运输层通常在主机中作为用户操作系统的一部分用软件实现，采用简单而快速的方法是必要的，而链路层的差错检测在适配器中用专用的硬件实现，能快速执行更复杂的CRC操作

### 6.2.3 循环冗余检测

**循环冗余检测(Cyclic Redundancy Check, CRC)编码** 也被称为**多项式编码(polynomial code)**,

在这种方法中，考虑d比特的数据$D$，发送节点要把它发送给接收节点，两者首先要协商好一个$r+1$ 比特模式，称为**生成多项式(generator)**, 我们将其表示为$G$, 我们要求G的最高有效位必须为1。对于一个给定的数据段$D$, 发送方要选择$r$ 个附加比特$R$，并将它附加到D上，使得得到的$d+r$比特模式使用模2算术恰好能被G整除

对于模2运算，加法不进位，减法不借位，即加法与减法是相同的，都可以用XOR异或操作代替，即

​                $D\cdot 2^r$ XOR $R =  nG $

而同时两边用R异或，可以得到 $D\cdot 2^r =  nG$ XOR $R$，即$R = reminder\frac{D\cdot 2^r}{G}$

## 6.3 多路访问链路和协议

**广播链路(broadcast link)**能够使得多个发送和接收节点到连接到相同的、单一的、共享的广播信道上，使用“广播” 是因为任何一个节点在传输一个帧的时候，信道广播该帧，每个其他一个节点都会收到一个副本。

节点通过多路访问协议来规范他们在共享的广播信道上的传输行为

如果多个节点同时传输帧，那么也就是说传输的帧在所有的接收方处**碰撞(collide)**,所有涉及到此次碰撞的帧全部都损失了

目前的任何多路访问协议都可以划分为三种类型：信道划分协议、随机接入协议和轮流协议

对于一个速率位R bps的广播信道，理想的多路访问协议应该具备以下特性

- 当只有一个节点时，该节点有R bps的吞吐量
- 有M个节点发送数据时，每个节点在一些适当定义的时间内有R/M的平均传输速率
- 协议是分散的，不会因为某主节点故障而使得整个系统崩溃
- 协议是简单的，实现不昂贵

### 6.3.1信道划分协议

**TDM**: 将时间划分为时间帧，并进一步将每个帧划分为N个时隙，通常选择的时隙长度要能使一个时隙内能传输单个分组，能避免碰撞且非常公平，缺陷是节点被限制为R/N bps的平均传输速率，节点必须总是等待他在传输序列中的轮次，即使只有他一个节点

**FDM**：将R bps信道划分为不同的频段，每个频段具有R/N的带宽，并将每个频率分配给N个节点中的一个，缺点和TDM一样，限制一个节点只能使用R/N的带宽。

**码分多址(Code Division Multiple Access, CDMA)**: 对每个节点分配一种编码，然后每个节点用他唯一的编码对他发送的数据进行编码。如果进行选择这些编码，CDMA将可以使得不同节点能够同时传输，并且他们各自的相应的接收方仍能正确接收。(假设接收方能够直到发送方的编码)

### 6.3.2 随机接入协议

在随机接入协议中，涉及碰撞的每一个节点重发他的帧（也就是分组），直到帧无障碍的通过为止，但是他在重发该帧之前会等待一个随机时延。每个节点独立选择随机时延。我们在本块描述一些最常用的随机接入协议

#### 时隙ALOHA

做如下假设：
* 所有帧都是L比特
* 将时间划分为长度为L/R的时隙(也就是说一个时隙等于传输一帧的时间)，
* 节点值在时隙起点开始传输帧
* 时间是同步的，每个节点都知道时隙何时开始。
* 如果在一个时隙中发生碰撞，则所有节点在该时隙结束前检测到该事件

令$p$是一个概率，操作如下：
* 在每个节点中，当节点有一个新帧要发送时，他等到下一个时隙开始并在该时隙传输整个帧
* 如果没有碰撞则成功传输（此时如果又新帧，他能够为传输准备一个新帧）
* 如果有碰撞，节点能够在时隙结束前检测到碰撞，该节点在后续的每一个时隙中都以概率p的可能性去重传这个帧直到其传输成功。

除了发生碰撞的帧之外，还有可能会有某个时隙是空闲的，只有刚好有一个节点传输的时隙叫做**成功时隙**，时隙多路访问协议的**效率** 定义为：当有大量的活跃节点且每个节点总有大量的帧要发送时，长期运行中成功时隙的份额。

可以分析得到这个协议的最大效率是0.37。

#### ALOHA

时隙ALOHA要求所有节点同步他们的传输，而单纯的ALOHA是非时隙的

当第一帧到达时立刻开始传输，如果碰撞，立刻以p的概率重传，否则等待一个帧的传输时间，再次以p的概率重传直到传输成功。

纯aloha协议只有时隙的效率的一半

#### 载波侦听多路访问：CSMA

**载波侦听(carrier sensing)**：一个节点在传输前先听信道，如果来自另一个节点的帧正向信道上发送，节点则等待直到检测到一小段时间(96比特时间)没有传输，然后开始传输

之所以侦听了还有可能碰撞的原因是端到端的**信道传播时延**,如B开始传输后但是还没到达D之前，D认为信道空闲开始传输

#### 具有碰撞检测的载波侦听多路访问：CSMA/CD

**碰撞检测(collision detection)**：当一个传输节点在传输时一直监听此信道，如果他检测到另一个节点正在传输干扰帧，就停止运输，在重复“侦听-当空闲时传输”循环前**等待一段随机时间**。

检测到碰撞后会发送Jam信号来强化碰撞让其余点也知道

CSMA/CD工作流程：
* 适配器从网络层一条获得数据报，准备链路层帧，并将其放入帧适配器缓存中
* 如果适配器检测到信道空闲，他开始传输帧。(传输前等待96比特时间，即最小帧间隔)另一方面，如果侦听到信道正在忙，就等待直到侦听到没有信号能量
* 传输过程中，适配器监视来自其他使用该广播信道的适配器的信号能量存在
* 如果传输整个帧而未检测到来自其他适配器的信号能量，该适配器就完成了传输，否则就停止传输
* 中止传输后，等待一个随机时间量

关于等待的随机时间确定，用于以太网和DOCSIS电缆网络多路访问协议中的**二进制指数后退**算法解决了这个问题，当传输一个帧发生了n次碰撞后，下一次的时间间隔K从$\{0,1,2,3,\cdots, 2^n-1\}$中等概率选取。此处选取的K代表的延迟时间为发送K*512比特所需要的时间。n最大为10，达到10后6次保持10不变，16次均失败后放弃重传

**CSMA/CD效率**：当有大量的活跃节点，且每个节点有大量的帧要发送时，帧在信道中无碰撞地运输那部分时间在长期运行时间中所占的份额。近似式$$\frac{1}{1+5d_{prop}/d_{trans}}$$

最小帧长：检测冲突的时长不超过端到端时延的两倍，取这一值为最小帧长

### 6.3.3 轮流协议

前面的ALOHA协议和CSMA协议具备了理想协议的第一个特性，但是不具备第二个特性(有M个节点发送数据时，每个节点在一些适当定义的时间内有R/M的平均传输速率). 轮流协议就是为满足这个协议而创造的。

轮流协议有很多种，此处讨论两种。

**轮询协议(polling protocol)**：节点之一被指定为主节点，主节点以循环的方式轮询每个节点，先向节点1发送报文告诉他节点1最多能传输的帧的数量，节点1传输了某些帧后，再告诉节点2。(主节点通过观察信道上是都缺乏信号来决定一个节点何时完成了传送)。 缺点是引入了轮询时延，因为即使只有一个活跃节点也要轮询每一个非活跃的节点，第二个缺点是主节点如果有故障，整个信道都将不可操作

轮询协议的典型例子是802.15协议和蓝牙协议

**令牌传递协议**：用一个称为**令牌(token)**的小的特殊帧再节点之间以某种固定的次序进行交换，一个节点收到令牌时，只有其需要发送一些帧的时候才持有该令牌，否则其立即向下一个节点转发该令牌，如果其有帧要传输，则发送最大数目的帧数，然后向下一个节点转发。其缺点是一个节点的故障可能导致整个信道崩溃或者一个节点偶然忘记了释放令牌，这些必须调用某些恢复步骤使令牌返回到循环中来。

#### 6.3.4 DOCSIS：用于电缆因特网接入的链路层协议

一个电缆接入网通常在电缆网头端将几千个住宅电缆调制解调器与一个**电缆调制解调器端接系统(CMTS)**连接，**数据经电缆服务接口（Data-Over-Cable Service Interface, DOCSIS）**规范定义了电缆数据网络体系结构及其协议。

DOCSIS使用FDM将下行(CMTS到调制解调器)和上行网络段划分为多个频率信道。

此处略去n字

## 6.4 交换局域网

### 6.4.1 链路层寻址和ARP

ARP：从IP地址到链路层地址的地址解析协议

#### MAC地址

事实上，并不是主机或者路由器具有链路层地址，而是他们的适配器（网络接口）具有链路层地址。

但是链路层交换机并**不具有**与他们接口相关联的链路层地址。因为链路层交换机的任务是在主机和路由器之间承载数据报，交换机透明的执行该任务 。

链路层地址有各种不同的称呼：**LAN地址**，**物理地址**，**MAC地址**，这三者表示同一个东西

对于大多数局域网而言，MAC地址长度为6字节，每一块适配器的MAC地址都是不同的，且一个适配器的MAC地址都不会变化。MAC地址使用十六进制表示，每个字节表示为一对十六进制数，如5C-66-AB-90-75-B1这种表示方式

发送适配器会将目的适配器的MAC地址插入到帧中，并将该帧发送到局域网中，一台交换机偶尔将这个帧广播到所有接口，适配器接收到一个帧的时候，检验该帧中的MAC地址是否与自己的匹配，若匹配则提取出封装的数据并沿着协议栈向上传递，否则就丢弃。

如果需要使得局域网内所有适配器都接收到一个帧的信息，则插入一个特殊的**MAC广播地址**，对于使用6字节的局域网(如以太网和802.11)来说，广播地址是48个1组成的字符串(FF-FF-FF-FF)

#### 地址解析协议

地址解析协议：将网络层地址转化为链路层地址

每台主机或者路由器的内存中都有一个ARP表中，取在相同局域网内的任意IP地址作为输入，可以返回相应的MAC地址。同时这个表中包含了一个寿命值，指示了表中删除每个映射的时间，一个表项通常的过期时间是20分钟。

ARP只为在同一个子网内的主机和路由器接口解析IP地址

如果发送主机的ARP表中没有目的主机的表项，则发送方用ARP协议来解析这个地址，构造一个称为**ARP分组(ARP packet)**的特殊分组，包括了发送和接收IP地址以及MAC地址，ARP的查询分组和响应分组有着相同的格式，构造完成后，适配器用广播地址来发送这个分组，并传入子网中，而包含该ARP查询的帧能被子网上所有适配器接收到，每个适配器将该ARP分组向上传递给ARP模块，这些ARP模块检查其IP地址是否与ARP分组中的目的IP地址一致，与之匹配的一个给查询主机发送回一个带有所希望映射的响应ARP分组。然后查询主机更新其ARP表并发送其IP数据报。

#### 发送数据到子网之外

路由器的每个接口都有一个IP和适配器(MAC地址)。

考虑一个连接了两个子网的路由器，发送主机通过ARP找到路由器的MAC地址并向其转发（转发的帧中包括了其他子网的目标IP）,路由器看到这个是向其寻址后传递给路由器的网络层，网络层通过查询路由器中的转发表得到器通过哪个接口转发，路由器通过ARP获取了另一个子网的目标主机的MAC地址，通过接口向这个适配器传递

### 6.4.2 以太网

以太网：有线局域网

在20世纪90年代后期，大多数公司和大学使用一种基于**集线器(hub)**的星形拓扑以太网安装，集线器是一种物理层设备，他作用于比特而不是帧，当一个比特到达一个接口时，集线器重新生成一个能量更大的相同的比特，并向所有其他接口传输出去。这是可能发生碰撞的。

在21实际，以太网继续使用星形拓扑，但是将集线器换成了**交换机(switch)**, 交换机是**无碰撞**的，并且是名副其实的存储转发分组交换机。

#### 以太网的帧结构

> `前同步码` `目的地址` `源地址` `类型` `数据` `CRC`

数据字段（46-1500字节）：承载了IP数据，以太网的最大传输单位（MTU）是1500字节，这意味着如果IP数据报超过了1500字节则需要分片，数据字段最小为46字节，如果少于46字节则需要填充至46字节，网络层接收到数据报后可以根据IP数据报首部的长度字段来去除填充部分。(最小帧长的确定：端到端时延的两倍)

目的地址 (6字节)： 包含了目的适配器的MAC地址

源地址(6字节)： 传输该帧到局域网上的适配器MAC地址

类型字段(2字节)：类型字段允许以太网复用多种网络层协议，当以太网帧到达适配器B后，B需要知道其将数据字段内容传递给哪个网络层协议。

CRC（4字节）：循环冗余检测

前同步码(8字节)： 前7字节为10101010，最后一个字节为10101011，其前七个字节的作用在于唤醒接收适配器，并它们的时钟和发送方的始终同步，前同步码的第八个字节最后两个比特用来警告适配器“重要的内容来了”。

以太网向网络层提供不可靠技术，即适配器B收到A的帧后，不会告诉A是否通过了CRC校验，如果没有通过校验则直接丢弃该帧，如果应用使用了UDP协议，则可以看到数据中的间隙，如果使用TCP协议，那么TCP将不会确认包含在这个数据帧中的数据，从而引起A中的TCP协议进行重传。

#### 以太网技术

* 命名：\[速率\]BASE\[速率或者介质\]
* BASE: 基带以太网
* T：双绞铜线

现代的交换机可以协调运输，在任何时刻都不会向相同接口转发超过一个帧，此外现代交换机都是双全工的，即一台交换机可以和一个节点同时向对方发送帧而不会产生干扰，因此基于交换机的以太局域网中，不会有碰撞，已经没有必要使用MAC协议了

### 6.4.3 链路层交换机

交换机的任务是接收入链路层帧并把他们转发到出链路。

#### 交换机转发和过滤

**过滤(filtering)**：决定一个帧应该转发到某个接口还是应当将其丢弃

**转发(forwarding)**: 决定一个帧应该被导向哪个接口，并把该帧移动到那些接口。

交换机的过滤和转发借助于**交换机表(switch table)**完成，交换机表中的一个表项包括：一个MAC地址、通往该MAC地址的交换机接口、表项放置在表中的时间。

假设目的地址为DD-DD-DD-DD-DD-DD的帧从接口x到达，

- 如果表中没有DD-DD-..的表项，交换机向除了接口x之外的所有接口前面的输出缓存转发该帧的副本，换而言之，如果没有对于目的地址的表项，交换机广播该帧。
- 如果有DD-DD-..的表项，且接口为x，则直接采用丢弃该帧执行过滤功能即可
- 如果有DD-DD-..的表项，且接口不是x，则交换机将该帧翻到对应接口前面的输出缓存完成转发功能

#### 自学习

交换机是自学习的，交换机表初始为空，对于在每个接口接收到的每个入帧，该交换机在其表中存储该帧源地址对应的MAC地址以及到达的接口，并记录当前时间。如果在一段时间(*老化期* )中，交换机没有接收到以该地址为源地址的帧，就在表中删除该地址。

交换机是即插即用设备，因为他们不需要网络管理员和用户的干预

#### 链路层交换机的性质

**消除碰撞**：交换机缓存帧且绝不会再网段上同时传输超过一个帧，其最大聚合带宽是该交换机所有接口速率之和

**异质的链路**：交换机将链路彼此隔离，使其能以不同速率在不同媒体上运行

**管理**： 易于进行网络管理

#### 交换机与路由器的区别

交换机是第二层的，路由器是第三层的

> to be add

